<section class="py-5 bg-light">
    <div class="container px-5">
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb bg-white p-3 rounded-4 shadow-sm">
                <li class="breadcrumb-item"><a href="/categories/vitrine_do_trabalhador/hub" class="text-decoration-none text-primary fw-bold">Hub</a></li>
                <li class="breadcrumb-item active fw-semibold">Detalhes do Anúncio</li>
            </ol>
        </nav>

        <div class="row gx-5">
            <div class="col-lg-8">
                <div class="card shadow-lg border-0 rounded-4 overflow-hidden mb-4 bg-white">
                    {{#if vitrine.imagens.length}}
                        <div id="carouselMelhoria" class="carousel slide bg-dark" data-bs-ride="carousel">
                            <div class="carousel-inner">
                                {{#each vitrine.imagens}}
                                <div class="carousel-item {{#if @first}}active{{/if}} text-center">
                                    <img src="{{this}}" class="img-fluid" style="max-height: 550px; width: 100%; object-fit: cover;">
                                </div>
                                {{/each}}
                            </div>
                            {{#if (gt vitrine.imagens.length 1)}}
                                <button class="carousel-control-prev" type="button" data-bs-target="#carouselMelhoria" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon shadow-sm" aria-hidden="true"></span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#carouselMelhoria" data-bs-slide="next">
                                    <span class="carousel-control-next-icon shadow-sm" aria-hidden="true"></span>
                                </button>
                            {{/if}}
                        </div>
                    {{else}}
                        <div class="bg-secondary text-white text-center py-5">
                            <i class="bi bi-image fs-1"></i>
                            <p class="mt-2">Nenhuma imagem anexada</p>
                        </div>
                    {{/if}}

                    <div class="card-body p-4 p-md-5">
                        <div class="d-flex align-items-center mb-3 flex-wrap gap-2">
                            <span class="badge bg-success px-3 py-2 rounded-pill">Anúncio Ativo</span>
                            <span class="badge bg-primary-soft text-primary px-3 py-2 rounded-pill border border-primary">
                                <i class="bi bi-tag-fill me-1"></i> {{vitrine.categoriaExibida}}
                            </span>
                            <small class="text-muted ms-auto"><i class="bi bi-calendar3 me-1"></i> {{formatDate vitrine.dataCriacao}}</small>
                        </div>
                        
                        <h1 class="fw-bold text-dark display-6 mb-3">{{vitrine.titulo}}</h1>
                        <p class="lead text-secondary mb-4" style="line-height: 1.8; white-space: pre-line;">{{vitrine.descricao}}</p>

                        <div class="row mb-5">
                            {{#if vitrine.produtos}}
                            <div class="col-md-6 mb-3">
                                <div class="p-3 border rounded-4 bg-light h-100">
                                    <h6 class="fw-bold text-success mb-2"><i class="bi bi-box-seam me-2"></i>Principais Produtos</h6>
                                    <p class="mb-0 text-dark">{{vitrine.produtos}}</p>
                                </div>
                            </div>
                            {{/if}}
                            
                            {{#if vitrine.servicos}}
                            <div class="col-md-6 mb-3">
                                <div class="p-3 border rounded-4 bg-light h-100">
                                    <h6 class="fw-bold text-primary mb-2"><i class="bi bi-tools me-2"></i>Principais Serviços</h6>
                                    <p class="mb-0 text-dark">{{vitrine.servicos}}</p>
                                </div>
                            </div>
                            {{/if}}
                        </div>

                        <div class="mb-4">
                            <h6 class="fw-bold text-dark mb-3"><i class="bi bi-map-fill me-2 text-danger"></i>Localização Geográfica</h6>
                            <div id="mapDetails" class="rounded-4 border shadow-sm mb-3" style="height: 300px; width: 100%; z-index: 1;"></div>
                            
                            <div class="p-3 bg-light rounded-4 border-start border-danger border-4">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-geo-alt-fill text-danger fs-4 me-3"></i>
                                    <div>
                                        <p class="small text-muted mb-0">Endereço Registrado</p>
                                        <span class="fw-bold text-dark">{{vitrine.localizacao}}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card border-0 shadow-sm rounded-4 p-4 mb-4 bg-white">
                    <h6 class="text-uppercase fw-bold text-muted small mb-3">Profissional Responsável</h6>
                    <div class="d-flex align-items-center mb-3">
                        <div class="icon-shape rounded-circle me-3 overflow-hidden shadow-sm" style="width: 55px; height: 55px; flex-shrink: 0; border: 2px solid #eee;">
                            {{#if vitrine.usuario.profileImage}}
                                <img src="{{vitrine.usuario.profileImage}}" alt="{{vitrine.usuario.name}}" class="w-100 h-100" style="object-fit: cover;">
                            {{else}}
                                <div class="bg-light text-primary w-100 h-100 d-flex align-items-center justify-content-center">
                                    <i class="bi bi-person-fill fs-4"></i>
                                </div>
                            {{/if}}
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold text-dark">{{vitrine.usuario.name}}</h6>
                            <small class="text-muted">{{vitrine.usuario.profession}}</small>
                        </div>
                    </div>
                    <a href="https://wa.me/55{{vitrine.contato}}" target="_blank" class="btn btn-success w-100 rounded-pill fw-bold py-2 mb-2 shadow-sm">
                        <i class="bi bi-whatsapp me-2"></i> Chamar no WhatsApp
                    </a>
                    <a href="/users/perfil/{{vitrine.usuario._id}}" class="btn btn-outline-primary w-100 rounded-pill fw-bold py-2 small">
                        Ver Perfil Completo
                    </a>
                </div>

                <div class="card border-0 shadow-sm rounded-4 p-3 mb-4 text-center bg-white">
                    <form action="/categories/vitrine_do_trabalhador/curtir/{{vitrine._id}}" method="POST">
                        {{#if jaCurtiu}} 
                            <button type="submit" class="btn btn-danger w-100 rounded-pill fw-bold py-2 shadow-sm transition-base">
                                <i class="bi bi-heart-fill me-2"></i> Você apoiou isto ({{vitrine.curtidas.length}})
                            </button>
                        {{else}}
                            <button type="submit" class="btn btn-outline-secondary w-100 rounded-pill fw-bold py-2 transition-base">
                                <i class="bi bi-heart me-2"></i> Apoiar Anúncio ({{vitrine.curtidas.length}})
                            </button>
                        {{/if}}
                    </form>
                </div>

                <div class="card border-0 shadow-sm rounded-4 overflow-hidden bg-white">
                    <div class="p-4 border-bottom bg-white">
                        <h6 class="fw-bold mb-0">Comentários <span class="badge bg-light text-dark ms-2">{{vitrine.comentarios.length}}</span></h6>
                    </div>

                    <div class="p-4 overflow-auto" style="max-height: 400px; background-color: #fafafa;">
                        {{#if vitrine.comentarios}}
                            {{#each vitrine.comentarios}}
                                <div class="d-flex align-items-start mb-3">
                                    <a href="/users/perfil/{{this.usuario._id}}" class="me-3 flex-shrink-0">
                                        <img src="{{this.usuario.profileImage}}" 
                                            alt="{{this.usuario.name}}" 
                                            class="rounded-circle shadow-sm" 
                                            style="width: 40px; height: 40px; object-fit: cover; border: 2px solid #fff;">
                                    </a>
                                    
                                    <div class="bg-white p-3 rounded-3 shadow-sm border w-100">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <a href="/users/perfil/{{this.usuario._id}}" class="text-decoration-none">
                                                <h6 class="fw-bold mb-0 hover-blue text-primary" style="font-size: 0.85rem;">
                                                    {{this.usuario.name}}
                                                </h6>
                                            </a>
                                            <small class="text-muted" style="font-size: 0.7rem;">
                                                {{formatDate this.createdAt}}
                                            </small>
                                        </div>
                                        <p class="mb-0 small text-dark">{{this.texto}}</p>
                                    </div>
                                </div>
                            {{/each}}
                        {{else}}
                            <p class="text-center text-muted small py-3">Seja o primeiro a comentar!</p>
                        {{/if}}
                    </div>

                    <div class="p-3 bg-white border-top">
                        <form action="/categories/vitrine_do_trabalhador/comentar/{{vitrine._id}}" method="POST">
                            <div class="input-group">
                                <input type="text" name="texto" class="form-control border-0 bg-light rounded-pill ps-4" placeholder="Escreva um comentário" required>
                                <button class="btn btn-primary rounded-circle ms-2 d-flex align-items-center justify-content-center shadow" type="submit" style="width: 40px; height: 40px;">
                                    <i class="bi bi-send-fill" style="font-size: 0.8rem;"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <a href="/categories/vitrine_do_trabalhador/hub" class="btn btn-link w-100 text-decoration-none mt-4 text-muted small fw-bold">
                    <i class="bi bi-arrow-left me-1"></i> Voltar para a lista
                </a>
            </div>
        </div>
    </div>
</section>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Pega as coordenadas vindas do banco de dados via Handlebars
        const lat = {{vitrine.latitude}};
        const lng = {{vitrine.longitude}};

        if (lat && lng) {
            const map = L.map('mapDetails').setView([lat, lng], 16);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(map);

            const customIcon = L.divIcon({
                className: 'custom-div-icon',
                html: "<div style='background-color:#dc3545; width:15px; height:15px; border-radius:50%; border:2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);'></div>",
                iconSize: [15, 15],
                iconAnchor: [7, 7]
            });

            L.marker([lat, lng], {icon: customIcon}).addTo(map)
                .bindPopup("<b>{{vitrine.titulo}}</b><br>Trabalhador(a) está aqui.")
                .openPopup();
        } else {
            document.getElementById('mapDetails').innerHTML = "<div class='d-flex align-items-center justify-content-center h-100'><p class='text-muted'>Localização não disponível.</p></div>";
        }
    });
</script>

<style>
    .hover-blue:hover { color: #0056b3 !important; text-decoration: underline; }
    .bg-primary-soft { background-color: rgba(13, 110, 253, 0.05); }
    .transition-base { transition: all 0.3s ease; }
    .rounded-4 { border-radius: 1.25rem !important; }
    #mapDetails { z-index: 1 !important; }
    .carousel-item img { border-radius: 0; }
</style>
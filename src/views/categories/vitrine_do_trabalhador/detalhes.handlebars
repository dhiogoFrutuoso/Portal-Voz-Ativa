<section class="py-5 bg-light">
    <div class="container px-5">
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb bg-white p-3 rounded-4 shadow-sm">
                <li class="breadcrumb-item"><a href="/categories/vitrine_do_trabalhador/hub" class="text-decoration-none text-primary fw-bold">Hub</a></li>
                <li class="breadcrumb-item active fw-semibold">Detalhes do Anúncio</li>
            </ol>
        </nav>

        <div class="row gx-5">
            <div class="col-lg-8">
                <div class="card shadow-lg border-0 rounded-4 overflow-hidden mb-4 bg-white">
                    {{#if vitrine.imagens.length}}
                        <div id="carouselVitrine" class="carousel slide bg-dark" data-bs-ride="carousel">
                            <div class="carousel-indicators">
                                {{#each vitrine.imagens}}
                                    <button type="button" data-bs-target="#carouselVitrine" data-bs-slide-to="{{@index}}" class="{{#if @first}}active{{/if}}" aria-current="true"></button>
                                {{/each}}
                            </div>
                            <div class="carousel-inner">
                                {{#each vitrine.imagens}}
                                <div class="carousel-item {{#if @first}}active{{/if}} text-center">
                                    <img src="{{this}}" class="img-fluid" style="max-height: 550px; width: 100%; object-fit: cover;" alt="Imagem do anúncio">
                                </div>
                                {{/each}}
                            </div>
                            {{#if (gt vitrine.imagens.length 1)}}
                                <button class="carousel-control-prev" type="button" data-bs-target="#carouselVitrine" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon shadow-sm" aria-hidden="true"></span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#carouselVitrine" data-bs-slide="next">
                                    <span class="carousel-control-next-icon shadow-sm" aria-hidden="true"></span>
                                </button>
                            {{/if}}
                        </div>
                    {{else}}
                        <div class="bg-secondary text-white text-center py-5">
                            <i class="bi bi-image fs-1"></i>
                            <p class="mt-2">Nenhuma imagem anexada</p>
                        </div>
                    {{/if}}

                    <div class="card-body p-4 p-md-5">
                        <div class="d-flex align-items-center mb-3">
                            <span class="badge bg-success px-3 py-2 rounded-pill me-3 shadow-sm">Anúncio Ativo</span>
                            <small class="text-muted"><i class="bi bi-calendar3 me-1"></i> Publicado em: {{formatDate vitrine.dataCriacao}}</small>
                        </div>
                        
                        <h1 class="fw-bold text-dark mb-3">{{vitrine.titulo}}</h1>
                        <hr class="my-4 opacity-25">
                        <p class="lead text-secondary mb-4" style="line-height: 1.8; white-space: pre-line;">{{vitrine.descricao}}</p>
                        
                        <div class="mt-5">
                            <h6 class="fw-bold text-dark mb-3"><i class="bi bi-geo-alt-fill me-2 text-danger"></i>Localização do Serviço</h6>
                            <div id="mapDetails" class="rounded-4 border shadow-sm mb-3" style="height: 350px; width: 100%; z-index: 1;"></div>
                            
                            <div class="p-3 bg-light rounded-4 border-start border-primary border-4 shadow-sm">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-info-circle-fill text-primary fs-4 me-3"></i>
                                    <div>
                                        <p class="small text-muted mb-0">Endereço de Referência</p>
                                        <span class="fw-bold text-dark">{{vitrine.localizacao}}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card border-0 shadow-lg rounded-4 p-4 mb-4 bg-white sticky-top" style="top: 20px;">
                    <h6 class="text-uppercase fw-bold text-muted small mb-3 border-bottom pb-2">Profissional Responsável</h6>
                    <div class="d-flex align-items-center mb-4">
                        <div class="position-relative me-3">
                            {{#if vitrine.usuario.profileImage}}
                                <img src="{{vitrine.usuario.profileImage}}" alt="{{vitrine.usuario.name}}" class="rounded-circle border border-2 border-white shadow-sm" style="width: 65px; height: 65px; object-fit: cover;">
                            {{else}}
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center shadow-sm" style="width: 65px; height: 65px;">
                                    <i class="bi bi-person-fill fs-3"></i>
                                </div>
                            {{/if}}
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold text-dark fs-5">{{vitrine.usuario.name}}</h6>
                            <small class="text-primary fw-semibold">{{vitrine.usuario.profession}}</small>
                        </div>
                    </div>
                    
                    <a href="https://wa.me/{{vitrine.whatsapp}}" target="_blank" class="btn btn-success w-100 rounded-pill fw-bold py-2 mb-3 shadow transition-base">
                        <i class="bi bi-whatsapp me-2"></i> Chamar no WhatsApp
                    </a>
                    
                    <div class="row g-2 mb-4">
                        <div class="col-6 text-center border-end">
                            <h6 class="mb-0 fw-bold">{{vitrine.curtidas.length}}</h6>
                            <small class="text-muted">Apoios</small>
                        </div>
                        <div class="col-6 text-center">
                            <h6 class="mb-0 fw-bold">{{vitrine.comentarios.length}}</h6>
                            <small class="text-muted">Comentários</small>
                        </div>
                    </div>

                    <form action="/categories/vitrine_do_trabalhador/curtir/{{vitrine._id}}" method="POST" class="mb-3">
                        {{#if jaCurtiu}} 
                            <button type="submit" class="btn btn-danger w-100 rounded-pill fw-bold py-2 shadow-sm transition-base">
                                <i class="bi bi-heart-fill me-2"></i> Você apoiou!
                            </button>
                        {{else}}
                            <button type="submit" class="btn btn-outline-danger w-100 rounded-pill fw-bold py-2 transition-base">
                                <i class="bi bi-heart me-2"></i> Apoiar Anúncio
                            </button>
                        {{/if}}
                    </form>

                    <div class="mt-4 border-top pt-4">
                        <h6 class="fw-bold mb-3"><i class="bi bi-chat-left-dots me-2"></i>Comentários</h6>
                        <div class="overflow-auto custom-scrollbar" style="max-height: 350px;">
                            {{#each vitrine.comentarios}}
                                <div class="d-flex mb-3 bg-light p-2 rounded-3 border">
                                    <img src="{{this.usuario.profileImage}}" class="rounded-circle me-2" style="width: 32px; height: 32px; object-fit: cover;">
                                    <div class="w-100">
                                        <div class="d-flex justify-content-between">
                                            <span class="small fw-bold text-dark">{{this.usuario.name}}</span>
                                            <span class="text-muted" style="font-size: 0.65rem;">{{formatDate this.createdAt}}</span>
                                        </div>
                                        <p class="mb-0 small text-secondary" style="font-size: 0.8rem;">{{this.texto}}</p>
                                    </div>
                                </div>
                            {{/each}}
                        </div>

                        <form action="/categories/vitrine_do_trabalhador/comentar/{{vitrine._id}}" method="POST" class="mt-3">
                            <div class="input-group">
                                <input type="text" name="texto" class="form-control border-light bg-light rounded-pill-start" placeholder="Comentar..." required>
                                <button class="btn btn-primary rounded-pill-end px-3" type="submit">
                                    <i class="bi bi-send"></i>
                                </button>
                            </div>
                        </form>
                    </div>

                    <a href="/categories/vitrine_do_trabalhador/hub" class="btn btn-link w-100 text-decoration-none mt-4 text-muted small fw-bold">
                        <i class="bi bi-arrow-left me-1"></i> Voltar para a vitrine
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const lat = {{vitrine.latitude}};
        const lng = {{vitrine.longitude}};

        if (lat && lng) {
            const map = L.map('mapDetails', {
                scrollWheelZoom: false // Evita zoom acidental ao rolar a página
            }).setView([lat, lng], 16);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(map);

            const customIcon = L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
                iconSize: [38, 38],
                iconAnchor: [19, 38]
            });

            L.marker([lat, lng], {icon: customIcon}).addTo(map)
                .bindPopup("<b>{{vitrine.titulo}}</b><br>O serviço está aqui!")
                .openPopup();
        } else {
            document.getElementById('mapDetails').innerHTML = `
                <div class="d-flex flex-column align-items-center justify-content-center h-100 bg-light text-muted">
                    <i class="bi bi-geo-alt fs-1"></i>
                    <p class="mt-2">Localização não disponível.</p>
                </div>`;
        }
    });
</script>

<style>
    .transition-base { transition: all 0.2s ease-in-out; }
    .transition-base:hover { transform: translateY(-2px); }
    .rounded-4 { border-radius: 1rem !important; }
    .rounded-pill-start { border-top-left-radius: 50rem !important; border-bottom-left-radius: 50rem !important; }
    .rounded-pill-end { border-top-right-radius: 50rem !important; border-bottom-right-radius: 50rem !important; }
    
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
    
    #carouselVitrine img {
        transition: transform 0.5s ease;
    }
    
    .carousel-indicators [data-bs-target] {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #fff;
    }
</style>